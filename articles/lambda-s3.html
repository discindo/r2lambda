<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>AWS Lambda and S3 integration • r2lambda</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="AWS Lambda and S3 integration">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">r2lambda</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/lambda-s3.html">AWS Lambda and S3 integration</a></li>
    <li><a class="dropdown-item" href="../articles/schedule-lambda.html">Set an AWS lambda function to run on a schedule</a></li>
    <li><a class="dropdown-item" href="../articles/tt-lambda.html">Tidy Tuesday dataset Lambda</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>AWS Lambda and S3 integration</h1>
            
      

      <div class="d-none name"><code>lambda-s3.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://discindo.github.io/r2lambda/">r2lambda</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dslc-io.github.io/tidytuesdayR/" class="external-link">tidytuesdayR</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>At the end of this tutorial, we would have created an AWS Lambda
function that fetches the most-recent Tidytuesday dataset and writes it
into an S3 Bucket every Wednesday. To do this, we’ll first work
interactively with <a href="https://discindo.github.io/r2lambda/">r2lambda</a> and <a href="https://github.com/paws-r/paws" class="external-link">paws</a> to go
through all the steps the Lambda function would eventually need to do,
then wrap the code and deploy it to AWS Lambda, and finally schedule it
to run weekly.</p>
</div>
<div class="section level2">
<h2 id="getting-started-with-aws-simple-storage-service-s3-from-r">Getting started with AWS Simple Storage Service (S3) from R<a class="anchor" aria-label="anchor" href="#getting-started-with-aws-simple-storage-service-s3-from-r"></a>
</h2>
<p>As with any AWS service supported by <a href="https://github.com/paws-r/paws" class="external-link">paws</a>, we can
easily connect to S3 and perform some basic operations. Below, we
establish an S3 service using <code><a href="../reference/aws_connect.html">r2lambda::aws_connect</a></code>, then
create a bucket called <code>tidytuesday-dataset</code>, drop and then
delete and empty file, and delete the bucket altogether. This exercise
is not very meaningful beyond learning the basics on how to interact
with S3 from <code>R</code>. Eventually, though, our lambda function
would need to do something similar, so being familiar with the process
in an interactive session helps.</p>
<p><strong>To run any of the code below, you need some environmental
variables set. See the <a href="https://github.com/discindo/r2lambda#build-a-docker-image-for-the-lambda-function" class="external-link">Setup</a>
section in the <a href="https://discindo.github.io/r2lambda/">r2lambda</a> package readme for more
details</strong></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s3_service</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aws_connect.html">aws_connect</a></span><span class="op">(</span><span class="st">"s3"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a bucket on S3</span></span>
<span><span class="va">s3_service</span><span class="op">$</span><span class="fu">create_bucket</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="st">"a-unique-bucket"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># upload an object to our bucket</span></span>
<span><span class="va">tmpfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"object_"</span>, fileext <span class="op">=</span> <span class="st">"txt"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/write.html" class="external-link">write</a></span><span class="op">(</span><span class="st">"test"</span>, <span class="va">tmpfile</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">tmpfile</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">s3_service</span><span class="op">$</span><span class="fu">put_object</span><span class="op">(</span>Body <span class="op">=</span> <span class="va">tmpfile</span>, Bucket <span class="op">=</span> <span class="st">"a-unique-bucket"</span>, Key <span class="op">=</span> <span class="st">"TestFile"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># list the contents of a bucket</span></span>
<span><span class="va">s3_service</span><span class="op">$</span><span class="fu">list_objects</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="st">"a-unique-bucket"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># delete an object from a bucket</span></span>
<span><span class="va">s3_service</span><span class="op">$</span><span class="fu">delete_object</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="st">"a-unique-bucket"</span>, Key <span class="op">=</span> <span class="st">"TestFile"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># delete a bucket</span></span>
<span><span class="va">s3_service</span><span class="op">$</span><span class="fu">delete_bucket</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="st">"a-unique-bucket"</span><span class="op">)</span></span></code></pre></div>
<p>Now, the above procedure used a local file, but what if we generated
some data during our session, and we want to stream that directly to S3
without saving to file? In many cases, we don’t have the option to write
to disk or simply don’t want to.</p>
<p>In such cases we need to serialize our data object before trying to
<code>put</code> it in the bucket. This comes down to calling
<code>serialize</code> with <code>connection=NULL</code> to generate a
<code>raw</code> vector without writing to a file. We can then put the
<code>iris</code> data set from memory into our
<code>a-unique-bucket</code> S3 bucket.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s3_service</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aws_connect.html">aws_connect</a></span><span class="op">(</span><span class="st">"s3"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a bucket on S3</span></span>
<span><span class="va">s3_service</span><span class="op">$</span><span class="fu">create_bucket</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="st">"a-unique-bucket"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># upload an object to our bucket</span></span>
<span><span class="va">siris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize</a></span><span class="op">(</span><span class="va">iris</span>, connection <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">s3_service</span><span class="op">$</span><span class="fu">put_object</span><span class="op">(</span>Body <span class="op">=</span> <span class="va">siris</span>, Bucket <span class="op">=</span> <span class="st">"a-unique-bucket"</span>, Key <span class="op">=</span> <span class="st">"TestFile2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># list the contents of a bucket</span></span>
<span><span class="va">s3_service</span><span class="op">$</span><span class="fu">list_objects</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="st">"a-unique-bucket"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># delete an object from a bucket</span></span>
<span><span class="va">s3_service</span><span class="op">$</span><span class="fu">delete_object</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="st">"a-unique-bucket"</span>, Key <span class="op">=</span> <span class="st">"TestFile2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># delete a bucket</span></span>
<span><span class="va">s3_service</span><span class="op">$</span><span class="fu">delete_bucket</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="st">"a-unique-bucket"</span><span class="op">)</span></span></code></pre></div>
<p>OK. With that, we now know the two steps our Lambda function would
need to do:</p>
<ol style="list-style-type: decimal">
<li>fetch the most recent Tidytuesday data set (see <a href="https://discindo.org/post/an-r-aws-lambda-function-to-download-tidytuesday-datasets/" class="external-link">this
post</a> for details)</li>
<li>put the data set as an object in the S3 bucket</li>
</ol>
<p>Still in an interactive session, lets just write the code that our
Lambda would have to execute.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dslc-io.github.io/tidytuesdayR/" class="external-link">tidytuesdayR</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Find the most recent tuesday and fetch the corresponding data set</span></span>
<span><span class="va">most_recent_tuesday</span> <span class="op">&lt;-</span> <span class="fu">tidytuesdayR</span><span class="fu">::</span><span class="fu">last_tuesday</span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tt_data</span> <span class="op">&lt;-</span> <span class="fu">tidytuesdayR</span><span class="fu">::</span><span class="fu">tt_load</span><span class="op">(</span>x <span class="op">=</span> <span class="va">most_recent_tuesday</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># by default it comes as class `tt_data`, which causes problems</span></span>
<span><span class="co"># with serialization and conversion to JSON. So best to extract</span></span>
<span><span class="co"># the data set(s) as a simple list</span></span>
<span><span class="va">tt_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tt_data</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">tt_data</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># then serialize</span></span>
<span><span class="va">tt_data_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize</a></span><span class="op">(</span><span class="va">tt_data</span>, connection <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a bucket on S3</span></span>
<span><span class="va">s3_service</span> <span class="op">&lt;-</span> <span class="fu">r2lambda</span><span class="fu">::</span><span class="fu"><a href="../reference/aws_connect.html">aws_connect</a></span><span class="op">(</span><span class="st">"s3"</span><span class="op">)</span></span>
<span><span class="va">s3_service</span><span class="op">$</span><span class="fu">create_bucket</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="st">"tidytuesday-datasets"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># upload an object to our bucket</span></span>
<span><span class="va">s3_service</span><span class="op">$</span><span class="fu">put_object</span><span class="op">(</span></span>
<span>  Body <span class="op">=</span> <span class="va">tt_data_raw</span>, </span>
<span>  Bucket <span class="op">=</span> <span class="st">"tidytuesday-datasets"</span>, </span>
<span>  Key <span class="op">=</span> <span class="va">most_recent_tuesday</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># list the contents of our bucket and find the Keys for all objects</span></span>
<span><span class="va">objects</span> <span class="op">&lt;-</span> <span class="va">s3_service</span><span class="op">$</span><span class="fu">list_objects</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="st">"tidytuesday-datasets"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">objects</span><span class="op">$</span><span class="va">Contents</span>, <span class="st">"[["</span>, <span class="st">"Key"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2023-03-07"</span></span>
<span></span>
<span><span class="co"># fetch a Tidytuesday dataset from S3</span></span>
<span><span class="va">tt_dataset</span> <span class="op">&lt;-</span> <span class="va">s3_service</span><span class="op">$</span><span class="fu">get_object</span><span class="op">(</span></span>
<span>  Bucket <span class="op">=</span> <span class="st">"tidytuesday-datasets"</span>, </span>
<span>  Key <span class="op">=</span> <span class="va">most_recent_tuesday</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># convert from raw and show the first few rows</span></span>
<span><span class="va">tt_dataset</span><span class="op">$</span><span class="va">Body</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/serialize.html" class="external-link">unserialize</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Now we should have everything we need to write our Lambda
function.</p>
</div>
<div class="section level2">
<h2 id="lambda-s3-integration-dropping-a-file-in-an-s3-bucket">Lambda + S3 integration: Dropping a file in an S3 bucket<a class="anchor" aria-label="anchor" href="#lambda-s3-integration-dropping-a-file-in-an-s3-bucket"></a>
</h2>
<p>Wrapping the above interactive code into a function and also,
defining an <code>s3_connect</code> function as a helper to create an S3
client within the function. By doing this, we avoid adding
<code>r2lambda</code> as a dependency to the Lambda function. (At the
time of writing, <code>r2lambda</code> does not yet support non-CRAN
packages.)</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tidytuesday_lambda_s3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">most_recent_tuesday</span> <span class="op">&lt;-</span> <span class="fu">tidytuesdayR</span><span class="fu">::</span><span class="fu">last_tuesday</span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">tt_data</span> <span class="op">&lt;-</span> <span class="fu">tidytuesdayR</span><span class="fu">::</span><span class="fu">tt_load</span><span class="op">(</span>x <span class="op">=</span> <span class="va">most_recent_tuesday</span><span class="op">)</span></span>
<span>  <span class="va">tt_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tt_data</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">tt_data</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">tt_data_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize</a></span><span class="op">(</span><span class="va">tt_data</span>, connection <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">s3_service</span> <span class="op">&lt;-</span> <span class="fu">paws</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/paws/man/s3.html" class="external-link">s3</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">s3_service</span><span class="op">$</span><span class="fu">put_object</span><span class="op">(</span>Body <span class="op">=</span> <span class="va">tt_data_raw</span>,</span>
<span>                        Bucket <span class="op">=</span> <span class="st">"tidytuesday-datasets"</span>,</span>
<span>                        Key <span class="op">=</span> <span class="va">most_recent_tuesday</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now, calling <code>tidytuesday_lambda_s3()</code> should fetch and
put the most recent Tidytuesday data set into our S3 bucket. To test it,
we run:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tidytuesday_lambda_s3</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">list_objects</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bucket</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">s3</span> <span class="op">&lt;-</span> <span class="fu">s3_connect</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">obj</span> <span class="op">&lt;-</span> <span class="va">s3</span><span class="op">$</span><span class="fu">list_objects</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="va">bucket</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">Contents</span>, <span class="st">"[["</span>, <span class="st">"Key"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">list_objects</span><span class="op">(</span><span class="st">"tidytuesday-datasets"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2023-03-07"</span></span></code></pre></div>
<p>On to the next step, to create and deploy the Lambda function. We
have a few considerations here:</p>
<ol style="list-style-type: decimal">
<li><p>We have some dependencies that would need to be available in the
docker image. We already saw how to install <a href="https://dslc-io.github.io/tidytuesdayR/" class="external-link">tidytuesdayR</a>
in our Lambda docker image in a <a href="https://discindo.org/post/an-r-aws-lambda-function-to-download-tidytuesday-datasets/" class="external-link">previous
post</a>. Besides this, we also need to install <a href="https://github.com/paws-r/paws" class="external-link">paws</a>,
because without it we can’t interact with S3. To do this, we just need
to add <code>dependencies = c("tidytuesdayR", "paws")</code> when
building the image with <code><a href="../reference/build_lambda.html">r2lambda::build_lambda</a></code>.</p></li>
<li>
</li>
<li><p>For the Lambda function to connect to S3, it needs access to some
environmental variables. The same ones as we have in our current
interactive session without which we can’t establish local clients of
AWS services. These are: <code>REGION</code>, <code>PROFILE</code>,
<code>SECRET_ACCESS_KEY</code>, and <code>ACCESS_KEY_ID</code>. To
include these envvars in the Lambda docker image on deploy, use the
<code>set_aws_envvars</code> argument of
<code>deploy_lambda</code>.</p></li>
</ol>
<div class="section level3">
<h3 id="build">Build<a class="anchor" aria-label="anchor" href="#build"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_code</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">  s3_connect &lt;- function() {</span></span>
<span><span class="st">    paws::s3(config = list(</span></span>
<span><span class="st">      credentials = list(</span></span>
<span><span class="st">        creds = list(</span></span>
<span><span class="st">          access_key_id = Sys.getenv('ACCESS_KEY_ID'),</span></span>
<span><span class="st">          secret_access_key = Sys.getenv('SECRET_ACCESS_KEY')</span></span>
<span><span class="st">        ),</span></span>
<span><span class="st">        profile = Sys.getenv('PROFILE')</span></span>
<span><span class="st">      ),</span></span>
<span><span class="st">      region = Sys.getenv('REGION')</span></span>
<span><span class="st">    ))</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  tidytuesday_lambda_s3 &lt;- function() {</span></span>
<span><span class="st">    most_recent_tuesday &lt;- tidytuesdayR::last_tuesday(date = Sys.Date())</span></span>
<span><span class="st">    tt_data &lt;- tidytuesdayR::tt_load(x = most_recent_tuesday)</span></span>
<span><span class="st">    tt_data &lt;- lapply(names(tt_data), function(x) tt_data[[x]])</span></span>
<span><span class="st">    tt_data_raw &lt;- serialize(tt_data, connection = NULL)</span></span>
<span><span class="st">    </span></span>
<span><span class="st">    s3_service &lt;- s3_connect()</span></span>
<span><span class="st">    s3_service$put_object(Body = tt_data_raw,</span></span>
<span><span class="st">                          Bucket = 'tidytuesday-datasets',</span></span>
<span><span class="st">                          Key = most_recent_tuesday)</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  lambdr::start_lambda()</span></span>
<span><span class="st">"</span></span>
<span></span>
<span><span class="va">tmpfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"tt_lambda_s3_"</span>, fileext <span class="op">=</span> <span class="st">".R"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/write.html" class="external-link">write</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">r_code</span>, file <span class="op">=</span> <span class="va">tmpfile</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">runtime_function</span> <span class="op">&lt;-</span> <span class="st">"tidytuesday_lambda_s3"</span></span>
<span><span class="va">runtime_path</span> <span class="op">&lt;-</span> <span class="va">tmpfile</span></span>
<span><span class="va">dependencies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tidytuesdayR"</span>, <span class="st">"paws"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">r2lambda</span><span class="fu">::</span><span class="fu"><a href="../reference/build_lambda.html">build_lambda</a></span><span class="op">(</span></span>
<span>  tag <span class="op">=</span> <span class="st">"tidytuesday_lambda_s3"</span>,</span>
<span>  runtime_function <span class="op">=</span> <span class="va">runtime_function</span>,</span>
<span>  runtime_path <span class="op">=</span> <span class="va">runtime_path</span>,</span>
<span>  dependencies <span class="op">=</span> <span class="va">dependencies</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="deploy">Deploy<a class="anchor" aria-label="anchor" href="#deploy"></a>
</h3>
<p>We set a generous 2 minute timeout, just to be safe that the data set
is successfully copied to S3. And we also increase the available memory
to 1024 mb. Note also the flag to pass along our local AWS envvars to
the deployed lambda environment.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">r2lambda</span><span class="fu">::</span><span class="fu"><a href="../reference/deploy_lambda.html">deploy_lambda</a></span><span class="op">(</span></span>
<span>  tag <span class="op">=</span> <span class="st">"tidytuesday_lambda_s3"</span>,</span>
<span>  set_aws_envvars <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  Timeout <span class="op">=</span> <span class="fl">120</span>,</span>
<span>  MemorySize <span class="op">=</span> <span class="fl">1024</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="invoke">Invoke<a class="anchor" aria-label="anchor" href="#invoke"></a>
</h3>
<p>We invoke as usual, with an empty list as payload because our
function does not take any arguments.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">r2lambda</span><span class="fu">::</span><span class="fu"><a href="../reference/invoke_lambda.html">invoke_lambda</a></span><span class="op">(</span></span>
<span>  function_name <span class="op">=</span> <span class="st">"tidytuesday_lambda_s3"</span>, </span>
<span>  invocation_type <span class="op">=</span> <span class="st">"RequestResponse"</span>, </span>
<span>  payload <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  include_logs <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; INFO [2023-03-08 23:50:46] [invoke_lambda] Validating inputs.</span></span>
<span><span class="co">#&gt; INFO [2023-03-08 23:50:46] [invoke_lambda] Checking function state.</span></span>
<span><span class="co">#&gt; INFO [2023-03-08 23:50:47] [invoke_lambda] Function state: Active.</span></span>
<span><span class="co">#&gt; INFO [2023-03-08 23:50:47] [invoke_lambda] Invoking function.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Lambda response payload: </span></span>
<span><span class="co">#&gt; {"Expiration":[],"ETag":"\"4f5a6085215b9074faed28d816696a99\"","ChecksumCRC32":[],</span></span>
<span><span class="co">#&gt; "ChecksumCRC32C":[],"ChecksumSHA1":[],"ChecksumSHA256":[],"ServerSideEncryption":"AES256",</span></span>
<span><span class="co">#&gt; "VersionId":[],"SSECustomerAlgorithm":[],"SSECustomerKeyMD5":[],"SSEKMSKeyId":[],</span></span>
<span><span class="co">#&gt; "SSEKMSEncryptionContext":[],"BucketKeyEnabled":[],"RequestCharged":[]}</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Lambda logs: </span></span>
<span><span class="co">#&gt; OpenBLAS WARNING - could not determine the L2 cache size on this system, assuming 256k</span></span>
<span><span class="co">#&gt; INFO [2023-03-09 05:50:49] Using handler function  tidytuesday_lambda_s3</span></span>
<span><span class="co">#&gt; START RequestId: c6cb0600-3400-4ca3-9232-8af53542f8e8 Version: $LATEST</span></span>
<span><span class="co">#&gt; --- Compiling #TidyTuesday Information for 2023-03-07 ----</span></span>
<span><span class="co">#&gt; --- There is 1 file available ---</span></span>
<span><span class="co">#&gt; --- Starting Download ---</span></span>
<span><span class="co">#&gt; Downloading file 1 of 1: `numbats.csv`</span></span>
<span><span class="co">#&gt; --- Download complete ---</span></span>
<span><span class="co">#&gt; END RequestId: c6cb0600-3400-4ca3-9232-8af53542f8e8</span></span>
<span><span class="co">#&gt; REPORT RequestId: c6cb0600-3400-4ca3-9232-8af53542f8e8   Duration: 12061.06 ms   </span></span>
<span><span class="co">#&gt; Billed Duration: 13331 ms    Memory Size: 1024 MB    Max Memory Used: 181 MB Init </span></span>
<span><span class="co">#&gt; Duration: 1269.59 ms </span></span>
<span><span class="co">#&gt; SUCCESS [2023-03-08 23:51:01] [invoke_lambda] Done.</span></span></code></pre></div>
<p>Then, to confirm that a Tidytuesday data set was written to S3 as an
object in the bucket <code>tidytuesday-datasets</code> we would run:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s3_service</span> <span class="op">&lt;-</span> <span class="fu">r2lambda</span><span class="fu">::</span><span class="fu"><a href="../reference/aws_connect.html">aws_connect</a></span><span class="op">(</span>service <span class="op">=</span> <span class="st">"s3"</span><span class="op">)</span></span>
<span><span class="va">objs</span> <span class="op">&lt;-</span> <span class="va">s3_service</span><span class="op">$</span><span class="fu">list_objects</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="st">"tidytuesday-datasets"</span><span class="op">)</span></span>
<span><span class="va">objs</span><span class="op">$</span><span class="va">Contents</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Key</span></span>
<span><span class="co">#&gt; [1] "2023-03-07"</span></span></code></pre></div>
<p>We expect to see one object with a <code>Key</code> matching the date
of the most recent Tuesday. At the time of writing that is March 7,
2023.</p>
</div>
<div class="section level3">
<h3 id="schedule">Schedule<a class="anchor" aria-label="anchor" href="#schedule"></a>
</h3>
<p>Finally, to copy the Tidytuesday dataset on a weekly basis, for
example, every Wednesday, we would use
<code><a href="../reference/schedule_lambda.html">r2lambda::schedule_lambda</a></code> with an execution rate set by
<code>cron</code>.</p>
<p>First, to validate that things are working, we can set the lambda on
a 5-minute schedule and check the time stamp on the on the S3 object to
make sure it is updated every 5 minutes:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># schedule the lambda to execute every 5 minutes</span></span>
<span><span class="fu">r2lambda</span><span class="fu">::</span><span class="fu"><a href="../reference/schedule_lambda.html">schedule_lambda</a></span><span class="op">(</span></span>
<span>  lambda_function <span class="op">=</span> <span class="st">"tidytuesday_lambda_s3"</span>, </span>
<span>  execution_rate <span class="op">=</span> <span class="st">"rate(5 minutes)"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># occasionally query the S3 bucket status and the LastModified time stamp</span></span>
<span><span class="va">objs</span> <span class="op">&lt;-</span> <span class="va">s3_service</span><span class="op">$</span><span class="fu">list_objects</span><span class="op">(</span>Bucket <span class="op">=</span> <span class="st">"tidytuesday-datasets"</span><span class="op">)</span></span>
<span><span class="va">objs</span><span class="op">$</span><span class="va">Contents</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">LastModified</span></span></code></pre></div>
<p>If all is well, set it to run every Wednesday at midnight:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">r2lambda</span><span class="fu">::</span><span class="fu"><a href="../reference/schedule_lambda.html">schedule_lambda</a></span><span class="op">(</span></span>
<span>  lambda_function <span class="op">=</span> <span class="st">"tidytuesday_lambda_s3"</span>,</span>
<span>  execution_rate <span class="op">=</span> <span class="st">"cron(0 0 * * Wed *)"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Next Wednesday morning, we should have two objects, with keys
matching the two most-recent Tuesdays.</p>
</div>
</div>
<div class="section level2">
<h2 id="lambda-s3-integration-triggering-lambda-when-on-new-file-in-s3-bucket">Lambda + S3 integration: Triggering Lambda when on new file in S3
bucket<a class="anchor" aria-label="anchor" href="#lambda-s3-integration-triggering-lambda-when-on-new-file-in-s3-bucket"></a>
</h2>
<div class="section level3">
<h3 id="todo">TODO<a class="anchor" aria-label="anchor" href="#todo"></a>
</h3>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Teofil Nakov.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
