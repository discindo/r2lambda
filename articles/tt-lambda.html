<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="r2lambda">
<title>Tidy Tuesday dataset Lambda • r2lambda</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tidy Tuesday dataset Lambda">
<meta property="og:description" content="r2lambda">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">r2lambda</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/lambda-s3.html">AWS Lambda and S3 integration</a>
    <a class="dropdown-item" href="../articles/schedule-lambda.html">Set an AWS lambda function to run on a schedule</a>
    <a class="dropdown-item" href="../articles/tt-lambda.html">Tidy Tuesday dataset Lambda</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Tidy Tuesday dataset Lambda</h1>
            
      
      
      <div class="d-none name"><code>tt-lambda.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://discindo.github.io/r2lambda/">r2lambda</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://arxiv.org/abs/1403.2805" class="external-link">jsonlite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="use-r2lambda-to-download-tidytuesday-dataset">Use <code>{r2lambda}</code> to download Tidytuesday dataset<a class="anchor" aria-label="anchor" href="#use-r2lambda-to-download-tidytuesday-dataset"></a>
</h2>
<p>In this exercize, we’ll create an AWS Lambda function that downloads
the <a href="https://github.com/rfordatascience/tidytuesday/tree/master/data/2023/2023-02-07" class="external-link">tidytuesday</a>
data set for the most recent Tuesday (or most recent Tuesday from a date
of interest).</p>
</div>
<div class="section level2">
<h2 id="runtime-function">Runtime function<a class="anchor" aria-label="anchor" href="#runtime-function"></a>
</h2>
<p>The first step is to write the runtime function. This is the function
that will be executed when we invoke the Lambda function after it has
been deployed. To download the Tidytuesday data set, we will use the
<a href="https://github.com/thebioengineer/tidytuesdayR" class="external-link">tidytuesdayR</a> package. In the runtime script, we define a
function called <code>tidytyesday_lambda</code> that takes one optional
argument <code>date</code>. If <code>date</code> is omitted, the
function returns the data set(s) for the most recent Tuesday, otherwise,
it looks up the most recent Tuesday from a date of interest and returns
the corresponding data set(s).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/thebioengineer/tidytuesdayR" class="external-link">tidytuesdayR</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">tidytuesday_lambda</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">date</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">most_recent_tuesday</span> <span class="op">&lt;-</span> <span class="fu">tidytuesdayR</span><span class="fu">::</span><span class="fu">last_tuesday</span><span class="op">(</span>date <span class="op">=</span> <span class="va">date</span><span class="op">)</span></span>
<span>  <span class="va">tt_data</span> <span class="op">&lt;-</span> <span class="fu">tidytuesdayR</span><span class="fu">::</span><span class="fu">tt_load</span><span class="op">(</span>x <span class="op">=</span> <span class="va">most_recent_tuesday</span><span class="op">)</span></span>
<span>  <span class="va">data_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tt_data</span><span class="op">)</span></span>
<span>  <span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">data_names</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">tt_data</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">data_list</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">tidytuesday_lambda</span><span class="op">(</span><span class="st">"2022-02-02"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="r-script-to-build-the-lambda">R script to build the lambda<a class="anchor" aria-label="anchor" href="#r-script-to-build-the-lambda"></a>
</h2>
<p>To build the lambda image, we need an <code>R</code> script that
sources any required code, loads any needed libraries, defines a runtime
function, and ends with a call to <code><a href="https://lambdr.mdneuzerling.com/reference/start_lambda.html" class="external-link">lambdr::start_lambda()</a></code>.
The runtime function does not have to be defined in this file. We could,
for example, source another script, or load a package and set a loaded
function as the runtime function in the subsequent call to
<code><a href="../reference/build_lambda.html">r2lambda::build_lambda</a></code> (see below). We save this script to
a file and record the path:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_code</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">  library(tidytuesdayR)</span></span>
<span><span class="st"></span></span>
<span><span class="st">  tidytuesday_lambda &lt;- function(date = NULL) {</span></span>
<span><span class="st">    if (is.null(date))</span></span>
<span><span class="st">      date &lt;- Sys.Date()</span></span>
<span><span class="st">    </span></span>
<span><span class="st">    most_recent_tuesday &lt;- tidytuesdayR::last_tuesday(date = date)</span></span>
<span><span class="st">    tt_data &lt;- tidytuesdayR::tt_load(x = most_recent_tuesday)</span></span>
<span><span class="st">    data_names &lt;- names(tt_data)</span></span>
<span><span class="st">    data_list &lt;- lapply(data_names, function(x) tt_data[[x]])</span></span>
<span><span class="st">    return(data_list)</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  lambdr::start_lambda()</span></span>
<span><span class="st">"</span></span>
<span></span>
<span><span class="va">tmpfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"ttlambda_"</span>, fileext <span class="op">=</span> <span class="st">".R"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/write.html" class="external-link">write</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">r_code</span>, file <span class="op">=</span> <span class="va">tmpfile</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="build-test-and-deploy-the-lambda-function">Build, test, and deploy the lambda function<a class="anchor" aria-label="anchor" href="#build-test-and-deploy-the-lambda-function"></a>
</h2>
<div class="section level3">
<h3 id="build">1. Build<a class="anchor" aria-label="anchor" href="#build"></a>
</h3>
<ul>
<li><p>We set the <code>runtime_function</code> argument to the name of
the function we wish the <code>docker</code> container to run when
invoked. In this case, this is <code>tidytuesday_lambda</code>. This
adds a <code>CMD</code> instruction to the
<code>Dockerfile</code></p></li>
<li><p>We set the <code>runtime_path</code> argument to the path we
stored the script defining our runtime function.</p></li>
<li><p>We set the <code>dependencies</code> argument to
<code>c("tidytuesdayR")</code>because we need to have the
<code>tidytuesdayR</code> package installed within the
<code>docker</code> container if we are to download the dataset. This
steps adds a <code>RUN</code> instruction to the <code>Dockerfile</code>
that calls <code>install.packages</code> to install
<a href="https://github.com/thebioengineer/tidytuesdayR" class="external-link">tidytuesdayR</a> from CRAN.</p></li>
<li><p>Finally, the <code>tag</code> argument sets the name of our
Lambda function which we’ll use later to test and invoke the function.
The <code>tag</code> argument also becomes the name of the folder that
<a href="https://discindo.github.io/r2lambda/">r2lambda</a> will create to build the image. This folder will
have two files, <code>Dockerfile</code> and <code>runtime.R</code>.
<code>runtime.R</code> is our script from <code>runtime_path</code>,
renamed before it is copied in the <code>docker</code> image with a
<code>COPY</code> instruction.</p></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">runtime_function</span> <span class="op">&lt;-</span> <span class="st">"tidytuesday_lambda"</span></span>
<span><span class="va">runtime_path</span> <span class="op">&lt;-</span> <span class="va">tmpfile</span></span>
<span><span class="va">dependencies</span> <span class="op">&lt;-</span> <span class="st">"tidytuesdayR"</span></span>
<span></span>
<span><span class="fu">r2lambda</span><span class="fu">::</span><span class="fu"><a href="../reference/build_lambda.html">build_lambda</a></span><span class="op">(</span></span>
<span>  tag <span class="op">=</span> <span class="st">"tidytuesday3"</span>,</span>
<span>  runtime_function <span class="op">=</span> <span class="va">runtime_function</span>,</span>
<span>  runtime_path <span class="op">=</span> <span class="va">runtime_path</span>,</span>
<span>  dependencies <span class="op">=</span> <span class="va">dependencies</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="test">2. Test<a class="anchor" aria-label="anchor" href="#test"></a>
</h3>
<p>To make sure our Lambda <code>docker</code> container works as
intended, we start it locally, and invoke it to test the response. The
response is a list of three elements:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">response</span> <span class="op">&lt;-</span> <span class="fu">r2lambda</span><span class="fu">::</span><span class="fu"><a href="../reference/test_lambda.html">test_lambda</a></span><span class="op">(</span>tag <span class="op">=</span> <span class="st">"tidytuesday3"</span>, payload <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>
<code>status</code>, should be 0 if the test worked,</li>
<li>
<code>stdout</code>, the standard output stream of the invocation,
and</li>
<li>
<code>stderr</code>, the standard error stream of the
invocation</li>
</ul>
<p><code>stdout</code> and <code>stderr</code> are <code>raw</code>
vectors that we need to parse, for example:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">rawToChar</a></span><span class="op">(</span><span class="va">response</span><span class="op">$</span><span class="va">stdout</span><span class="op">)</span> </span></code></pre></div>
<p>If the <code>stdout</code> slot of the response returns the correct
output of our function, we are good to deploy to AWS.</p>
</div>
<div class="section level3">
<h3 id="deploy">3. Deploy<a class="anchor" aria-label="anchor" href="#deploy"></a>
</h3>
<p>The deploy step is simple, in that all we need to do is specify the
name (tag) of the Lambda function we wish to push to AWS ECR. The
<code>deploy_lambda</code> function also accepts <code>...</code>, which
are named arguments ultimately passed onto
<code>paws.compute:::lambda_create_function</code>. This is the function
that calls the Lambda API. To see all available arguments run
<code>?paws.compute:::lambda_create_function</code>.</p>
<p>The most important arguments are probably <code>Timeout</code> and
<code>MemorySize</code>, which set the time our function will be allowed
to run and the amount of memory it will have available. In many cases it
will make sense to increase the defaults of 3 seconds and 128 mb.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">r2lambda</span><span class="fu">::</span><span class="fu"><a href="../reference/deploy_lambda.html">deploy_lambda</a></span><span class="op">(</span>tag <span class="op">=</span> <span class="st">"tidytuesday3"</span>, Timeout <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="invoke">4. Invoke<a class="anchor" aria-label="anchor" href="#invoke"></a>
</h3>
<p>If all goes well, our function should now be available on the cloud
awaiting requests. We can invoke it from <code>R</code> using
<code>invoke_lambda</code>. The arguments are:</p>
<ul>
<li>
<code>function_name</code> – the name of the function</li>
<li>
<code>invocation_type</code> – typically
<code>RequestResponse</code>
</li>
<li>
<code>include_log</code> – whether to print the logs of the run on
the console</li>
<li>
<code>payload</code> – a named list with arguments sent to the
<code>runtime_function</code>. In this case, the runtime function,
<code>tidytuesday_lambda</code> has a single argument <code>date</code>,
so the corresponding list is <code>list(date = Sys.Date())</code>. As
our function can be called without any argument, we can also send and
empty list as the payload.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">response</span> <span class="op">&lt;-</span> <span class="fu">r2lambda</span><span class="fu">::</span><span class="fu"><a href="../reference/invoke_lambda.html">invoke_lambda</a></span><span class="op">(</span></span>
<span>  function_name <span class="op">=</span> <span class="st">"tidytuesday3"</span>,</span>
<span>  invocation_type <span class="op">=</span> <span class="st">"RequestResponse"</span>,</span>
<span>  payload <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  include_logs <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Just like in the local test, the response payload comes as a raw
vector that needs to be parsed into a data.frame:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tidytuesday_dataset</span> <span class="op">&lt;-</span> <span class="va">response</span><span class="op">$</span><span class="va">Payload</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">rawToChar</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span>simplifyDataFrame <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tidytuesday_dataset</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Teofil Nakov.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
